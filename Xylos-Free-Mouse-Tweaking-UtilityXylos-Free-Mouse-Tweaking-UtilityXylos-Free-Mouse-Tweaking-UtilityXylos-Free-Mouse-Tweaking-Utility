/*
 * Xylo Mouse Tweaks – ALL-IN-ONE
 * 1) copy this file anywhere as xylo.c
 * 2) open CMD in that folder and run ONE of these single-line compilers:
 *
 *    --- Windows 10/11 (cl already on disk) ---
 *    "C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcvarsall.bat" x64 >nul 2>&1 && cl /O2 xylo.c
 *
 *    --- or 1-second fetch of 400 kB TCC ---
 *    curl -L -o tcc.zip https://github.com/TinyCC/tinycc/releases/download/release_0_9_27/tcc-0.9.27-win64-bin.zip && tar -xf tcc.zip && tcc\tcc -O2 xylo.c
 *
 * 3) right-click xylo.exe → “Run as administrator”, pick 1-4, reboot.
 *    No other files ever downloaded.
 */

#define _WIN32_WINNT 0x0600
#include <windows.h>
#include <stdio.h>

#pragma comment(lib,"advapi32.lib")

static BOOL isAdmin(void){
    BOOL b=0; PSID s;
    SID_IDENTIFIER_AUTHORITY a=SECURITY_NT_AUTHORITY;
    if(AllocateAndInitializeSid(&a,2,SECURITY_BUILTIN_DOMAIN_RID,DOMAIN_ALIAS_RID_ADMINS,0,0,0,0,0,0,&s)){
        CheckTokenMembership(NULL,s,&b); FreeSid(s);
    } return b;
}

static BOOL setDword(HKEY r,LPCWSTR path,LPCWSTR name,DWORD v){
    HKEY k; LONG rc=RegCreateKeyExW(r,path,0,NULL,REG_OPTION_NON_VOLATILE,KEY_WRITE,NULL,&k,NULL);
    if(rc==ERROR_SUCCESS){ rc=RegSetValueExW(k,name,0,REG_DWORD,(BYTE*)&v,sizeof(v)); RegCloseKey(k); }
    return rc==ERROR_SUCCESS;
}

static BOOL setSz(HKEY r,LPCWSTR path,LPCWSTR name,LPCWSTR v){
    HKEY k; LONG rc=RegCreateKeyExW(r,path,0,NULL,REG_OPTION_NON_VOLATILE,KEY_WRITE,NULL,&k,NULL);
    if(rc==ERROR_SUCCESS){ rc=RegSetValueExW(k,name,0,REG_SZ,(BYTE*)v,(DWORD)((wcslen(v)+1)*sizeof(WCHAR))); RegCloseKey(k); }
    return rc==ERROR_SUCCESS;
}

static BOOL tweakDelay(void){
    return setDword(HKEY_LOCAL_MACHINE,L"SYSTEM\\CurrentControlSet\\Services\\USB\\Parameters",L"SelectiveSuspendTimeout",1);
}

static BOOL tweakPrecision(void){
    return setSz(HKEY_CURRENT_USER,L"Control Panel\\Mouse",L"MouseSpeed",L"0") &&
           setSz(HKEY_CURRENT_USER,L"Control Panel\\Mouse",L"MouseThreshold1",L"0") &&
           setSz(HKEY_CURRENT_USER,L"Control Panel\\Mouse",L"MouseThreshold2",L"0");
}

static BOOL tweakPoll(DWORD hz){
    HKEY b; LONG rc=RegOpenKeyExW(HKEY_LOCAL_MACHINE,L"SYSTEM\\CurrentControlSet\\Enum\\USB",0,KEY_READ,&b);
    if(rc!=ERROR_SUCCESS)return 0;
    WCHAR n[256],s[512]; DWORD i=0,l;
    while((l=256,RegEnumKeyExW(b,i++,n,&l,NULL,NULL,NULL,NULL)==ERROR_SUCCESS)){
        wsprintfW(s,L"SYSTEM\\CurrentControlSet\\Enum\\USB\\%s\\Device Parameters",n);
        setDword(HKEY_LOCAL_MACHINE,s,L"PollingRate",hz);
    } RegCloseKey(b); return 1;
}

int main(void){
    if(!isAdmin()){ puts("Run me as Administrator."); return 1; }
    puts("=== Xylo Mouse Tweaks ===\n1) Input-delay fix\n2) 1000 Hz polling\n3) Disable accel\n4) All\nPick 1-4: ");
    int c; if(scanf("%d",&c)!=1||c<1||c>4){ puts("Bad choice."); return 1; }
    BOOL ok=1;
    switch(c){
        case 1: ok=tweakDelay(); break;
        case 2: ok=tweakPoll(1000); break;
        case 3: ok=tweakPrecision(); break;
        case 4: ok=tweakDelay()&tweakPoll(1000)&tweakPrecision(); break;
    }
    puts(ok?"Done – reboot or re-plug mouse.":"Failed – check drivers."); return ok?0:1;
}
